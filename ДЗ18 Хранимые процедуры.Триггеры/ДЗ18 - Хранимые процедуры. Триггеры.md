### Домашнее задание 18 ###
Текст функции для триггера:

CREATE OR REPLACE FUNCTION update_good_sum() RETURNS TRIGGER 
	AS $update_good_sum$
	    BEGIN
      -- Так как триггер работает на разные операции, проверяем тип операции
	        IF (TG_OP = 'DELETE') THEN
	            UPDATE good_sum_mart SET sum_sale= (SELECT sum(goods.good_price * sales.sales_qty)
	            FROM goods, sales
	            WHERE OLD.good_id = goods.goods_id
	            GROUP BY goods.good_name) WHERE good_name = (SELECT good_name FROM goods 
	            WHERE OLD.good_id = goods.goods_id) ;
              -- если все удалили, то сотрем запись с нулевой стоимостью продажи
	            DELETE from good_sum_mart WHERE good_sum_mart.sum_sale=0;
	        ELSIF (TG_OP = 'UPDATE') THEN
	            UPDATE good_sum_mart SET sum_sale= (SELECT sum(goods.good_price * sales.sales_qty)
	            FROM goods, sales
	            WHERE NEW.good_id = goods.goods_id
	            GROUP BY goods.good_name) WHERE good_name = (SELECT goods.good_name FROM goods
	            WHERE NEW.good_id = goods.goods_id) ;
	        ELSIF (TG_OP = 'INSERT') THEN
	        IF EXISTS (SELECT 1 FROM good_sum_mart WHERE good_sum_mart.good_name=
	            (SELECT goods.good_name FROM goods
	            WHERE NEW.good_id = goods.goods_id
	            ))  THEN 
	                UPDATE good_sum_mart SET sum_sale= (SELECT sum(goods.good_price * sales.sales_qty)
	                FROM goods,sales 
	                WHERE NEW.good_id = goods.goods_id
	                GROUP BY goods.good_name) WHERE good_name = (SELECT goods.good_name FROM goods
	                WHERE NEW.good_id = goods.goods_id) ;
	         ELSE
	            INSERT INTO good_sum_mart SELECT goods.good_name, sum(goods.good_price * sales.sales_qty)
	            FROM goods, sales
	            WHERE NEW.good_id = goods.goods_id
	            GROUP BY goods.good_name;
	         END IF;
	        END IF;
	        RETURN NULL; 
	    END;
	    $update_good_sum$
	LANGUAGE plpgsql
	
	Текст триггера:

  CREATE TRIGGER good_sum_trigger
AFTER INSERT OR UPDATE OR DELETE ON sales
    FOR EACH ROW EXECUTE PROCEDURE update_good_sum();

    Проверка операциями Insert, Delete, Update таблицы sales показала правильность работы  триггера. 




